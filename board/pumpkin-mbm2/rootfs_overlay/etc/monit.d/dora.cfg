# Goes into monit.d

# Main

check process comms with pidfile /var/run/comms.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/comms.pid -m -b --startas /usr/bin/dora/comms"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/comms.pid --retry 2 && rm /var/run/comms.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process cfdp with pidfile /var/run/cfdp.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/cfdp.pid -m -b --startas /usr/bin/dora/cfdp"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/cfdp.pid --retry 2 && rm /var/run/cfdp.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process payload with pidfile /var/run/payload.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/payload.pid -m -b --startas /usr/bin/dora/payload"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/payload.pid --retry 2 && rm /var/run/payload.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process i2c-control with pidfile /var/run/i2c-control.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/i2c-control.pid -m -b --startas /usr/bin/dora/i2c-control"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/i2c-control.pid --retry 2 && rm /var/run/i2c-control.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process scheduler with pidfile /var/run/scheduler.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/scheduler.pid -m -b --startas /usr/bin/dora/scheduler"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/scheduler.pid --retry 2 && rm /var/run/scheduler.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

# - 2 backups, 1 for upgrade 1 for original files


# Try to go back to the most recent upgrade first

check process comms-upgrade-backup with pidfile /var/run/comms-upgrade-backup.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/comms.pid -m -b --startas /usr/bin/dora/comms"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/comms-upgrade-backup.pid --retry 2 && rm /var/run/comms-upgrade-backup.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process cfdp with pidfile /var/run/cfdp.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/cfdp-upgrade-backup.pid -m -b --startas /usr/bin/dora/upgrade-backup/cfdp"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/cfdp-upgrade-backup.pid --retry 2 && rm /var/run/cfdp-upgrade-backup.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process payload with pidfile /var/run/payload.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/payload.pid -m -b --startas /usr/bin/dora/upgrade-backup/payload"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/payload.pid --retry 2 && rm /var/run/payload.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process i2c-control with pidfile /var/run/i2c-control.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/i2c-control.pid -m -b --startas /usr/bin/dora/upgrade-backup/i2c-control"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/i2c-control.pid --retry 2 && rm /var/run/i2c-control.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process scheduler with pidfile /var/run/scheduler.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/scheduler.pid -m -b --startas /usr/bin/dora/upgrade-backup/scheduler"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/scheduler.pid --retry 2 && rm /var/run/scheduler.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"


# Then drop back to the official backups last

check process comms-official-backup with pidfile /var/run/comms-official-backup.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/comms.pid -m -b --startas /usr/bin/dora/comms"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/comms.pid --retry 2 && rm /var/run/comms.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process cfdp-official-backup with pidfile /var/run/cfdp-official-backup.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/cfdp.pid -m -b --startas /usr/bin/dora/cfdp"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/cfdp.pid --retry 2 && rm /var/run/cfdp.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process payload-official-backup with pidfile /var/run/payload-official-backup.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/payload.pid -m -b --startas /usr/bin/dora/payload"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/payload-official-backup.pid --retry 2 && rm /var/run/payload-official-backup.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process i2c-control-official-backup with pidfile /var/run/i2c-control-official-backup.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/i2c-control.pid -m -b --startas /usr/bin/dora/i2c-control"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/i2c-control.pid --retry 2 && rm /var/run/i2c-control.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"

check process scheduler-official-backup with pidfile /var/run/scheduler-official-backup.pid
       start = "/sbin/start-stop-daemon -S -q -p /var/run/scheduler-official-backup.pid -m -b --startas /usr/bin/dora/scheduler"
       stop = "/bin/sh -c '/sbin/start-stop-daemon -K -q -p /var/run/scheduler-official-backup.pid --retry 2 && rm /var/run/scheduler-official-backup.pid'"
       if 2 restarts within 3 cycles then "/usr/bin/monit start backup-comms"